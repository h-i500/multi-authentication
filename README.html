<!DOCTYPE html>
<html>
<head>
<title>README.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="%E6%89%8B%E9%A0%86">æ‰‹é †</h1>
<h1 id="%E5%85%A8%E4%BD%93%E5%83%8F%E6%9C%80%E7%B5%82%E5%88%B0%E9%81%94%E5%BD%A2">å…¨ä½“åƒï¼ˆæœ€çµ‚åˆ°é”å½¢ï¼‰</h1>
<p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ <strong>Kong <code>/mashup</code></strong> â†’ <strong>Quarkus(é›†ç´„API)</strong> ãŒèªè¨¼ï¼ˆOIDCï¼‰
â†’ Quarkus ãŒ <strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® Access Token ã‚’ãã®ã¾ã¾ä¸‹æµã¸è»¢é€</strong>
â†’ <strong>Service A / Service B ã§å„è‡ªã®ãƒãƒªã‚·ãƒ¼ã§èªå¯</strong>
â†’ çµæœã‚’ãƒãƒ¼ã‚¸ã—ã¦è¿”å´</p>
<hr>
<h1 id="1-%E5%89%8D%E6%8F%90%E3%83%BB%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA">1. å‰æãƒ»ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª</h1>
<pre class="hljs"><code><div>.
â”œâ”€ docker-compose.yaml
â”œâ”€ kong-nginx-http.conf
â”œâ”€ init-konga-db.sql
â”œâ”€ quarkus-authz/           # é›†ç´„API (web-app + service ãƒ†ãƒŠãƒ³ãƒˆ)
â”œâ”€ service-a/
â””â”€ service-b/
</div></code></pre>
<hr>
<h1 id="2-%E3%83%93%E3%83%AB%E3%83%89%E5%90%84%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%82%92-fast-jar-%E3%81%A7">2. ãƒ“ãƒ«ãƒ‰ï¼ˆå„ã‚µãƒ¼ãƒ“ã‚¹ã‚’ fast-jar ã§ï¼‰</h1>
<p>å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§:</p>
<pre class="hljs"><code><div><span class="hljs-built_in">cd</span> quarkus-authz &amp;&amp; mvn clean package &amp;&amp; <span class="hljs-built_in">cd</span> ..
<span class="hljs-built_in">cd</span> service<span class="hljs-_">-a</span>     &amp;&amp; mvn clean package &amp;&amp; <span class="hljs-built_in">cd</span> ..
<span class="hljs-built_in">cd</span> service-b     &amp;&amp; mvn clean package &amp;&amp; <span class="hljs-built_in">cd</span> ..
</div></code></pre>
<blockquote>
<p>Dockerfile ã¯ <code>target/quarkus-app/...</code> ã¨ <code>quarkus-run.jar</code> å‰æãªã®ã§ã€<strong>å¿…ãš <code>mvn clean package</code> å®Ÿè¡Œ</strong>ã—ã¦ãã ã•ã„ã€‚</p>
</blockquote>
<hr>
<h1 id="3-%E8%B5%B7%E5%8B%95docker-compose">3. èµ·å‹•ï¼ˆDocker Composeï¼‰</h1>
<pre class="hljs"><code><div>docker compose up -d --build kong-database redis keycloak
<span class="hljs-comment"># æ•°ç§’å¾…æ©Ÿï¼ˆKeycloakèµ·å‹•å¾…ã¡ï¼‰</span>

<span class="hljs-comment"># åˆå›ã®ã¿ Kong DB ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œï¼š</span>
docker compose run --rm kong kong migrations bootstrap

docker compose up -d --build kong konga
docker compose up -d --build service<span class="hljs-_">-a</span> service-b quarkus-authz
</div></code></pre>
<blockquote>
<p><code>version</code> è­¦å‘Šã¯ç„¡è¦–å¯ã€‚<code>quarkus-authz/service-a/service-b</code> ã¯ 8080 ã§ Listenã€Compose ã§ 8081/9081/9082 ã«å…¬é–‹ã€‚</p>
</blockquote>
<hr>
<h1 id="4-keycloak-%E8%A8%AD%E5%AE%9Ademo-realm">4. Keycloak è¨­å®šï¼ˆdemo-realmï¼‰</h1>
<p>(ä»¥ä¸‹æ‰‹å‹•ã§å®Ÿæ–½ã™ã‚‹å ´åˆã§ã™ã€‚docker-composeèµ·å‹•æ™‚ã€./realms/demo-realm.jsonã®å†…å®¹ã‚’èª­ã¿è¾¼ã‚€ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™)</p>
<h2 id="41-realm%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E4%BD%9C%E6%88%90%E7%AE%A1%E7%90%86%E3%82%B3%E3%83%B3%E3%82%BD%E3%83%BC%E3%83%AB">4.1 Realm/ãƒ¦ãƒ¼ã‚¶ãƒ¼/ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆï¼ˆç®¡ç†ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼‰</h2>
<ul>
<li>ç®¡ç†UI: <a href="http://localhost:8080/">http://localhost:8080/</a>
Admin: <code>admin</code> / <code>admin</code></li>
</ul>
<ol>
<li>
<p><strong>Realm</strong>: <code>demo-realm</code> ä½œæˆ</p>
</li>
<li>
<p><strong>User</strong>: <code>testuser</code> ä½œæˆ</p>
<ul>
<li>Credentials: <code>password</code>ï¼ˆTemporary è§£é™¤ï¼‰</li>
</ul>
</li>
<li>
<p><strong>Clients</strong> 3ã¤ä½œæˆ</p>
<ul>
<li>
<p><code>quarkus-client</code>ï¼ˆé›†ç´„APIãƒ–ãƒ©ã‚¦ã‚¶ç”¨ï¼‰</p>
<ul>
<li>Access Type: Publicï¼ˆKeycloak 24 ã§ã¯ã€ŒClient authentication = Offã€ï¼‰</li>
<li>Standard Flowï¼ˆAuthorization Codeï¼‰= On</li>
<li>Direct Access Grantsï¼ˆPasswordï¼‰= Onï¼ˆé–‹ç™ºãƒ†ã‚¹ãƒˆç”¨ï¼‰</li>
<li>Valid Redirect URIs: <code>http://localhost:8081/*</code></li>
<li>Web Origins: <code>http://localhost:8081</code>ï¼ˆå¿…è¦ãªã‚‰ <code>+</code> ã§ã‚‚OKï¼‰</li>
</ul>
</li>
<li>
<p><code>service-a</code>ï¼ˆä¸‹æµAï¼‰</p>
<ul>
<li>Access Type: <strong>Bearer-only</strong>ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãªã—ï¼‰</li>
</ul>
</li>
<li>
<p><code>service-b</code>ï¼ˆä¸‹æµBï¼‰</p>
<ul>
<li>Access Type: <strong>Bearer-only</strong></li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Client Roles</strong></p>
<ul>
<li><code>service-a</code> ã® Roles: <code>read</code>, <code>user</code></li>
<li><code>service-b</code> ã® Roles: <code>read</code>, <code>user</code></li>
</ul>
</li>
<li>
<p><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ãƒ­ãƒ¼ãƒ«ä»˜ä¸</strong></p>
<ul>
<li><code>testuser</code> â†’ Role Mapping â†’ Client Roles â†’
<code>service-a: read, user</code> / <code>service-b: read, user</code> ã‚’ä»˜ä¸</li>
</ul>
</li>
<li>
<p><strong>Audience( aud ) ã« A/B ã‚’å«ã‚ã‚‹</strong></p>
<ul>
<li>
<p><code>quarkus-client</code> â†’ Client Scopes â†’ Add Mapper â†’ <strong>Audience</strong></p>
<ul>
<li>Included Client Audience: <code>service-a</code>, <code>service-b</code></li>
<li>Add to access token: ON
ï¼ˆã¾ãŸã¯ <code>quarkus-client</code> ã®ã€ŒMappersã€ã§ Audience ãƒãƒƒãƒ‘ã‚’2ã¤è¿½åŠ ã—ã¦ã‚‚è‰¯ã„ï¼‰</li>
</ul>
</li>
</ul>
</li>
</ol>
<blockquote>
<p>ã“ã‚Œã§ã€<code>quarkus-client</code> ã§å–å¾—ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã« <code>aud: [&quot;service-a&quot;,&quot;service-b&quot;,&quot;account&quot;]</code> ã¨
<code>resource_access.service-a.roles / service-b.roles</code> ãŒå…¥ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</p>
</blockquote>
<hr>
<h1 id="5-kong-%E3%81%AE%E3%83%AB%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0">5. Kong ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</h1>
<blockquote>
<p>OIDC ã¯ <strong>Quarkus ã«ä»»ã›ã‚‹</strong>ã®ã§ã€Kong å´ã¯<strong>ç´ é€šã—ãƒ«ãƒ¼ãƒˆ</strong>ã ã‘ä½œã‚Šã¾ã™ã€‚
ï¼ˆKonga UI ã§ä½œã£ã¦ã‚‚è‰¯ã„ã§ã™ãŒã€ã“ã“ã§ã¯ Admin API ä¾‹ï¼‰</p>
</blockquote>
<p>Admin API: <a href="http://localhost:8001">http://localhost:8001</a></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Quarkus é›†ç´„APIç”¨ã® Serviceï¼ˆDocker å†…åã«å‘ã‘ã‚‹ï¼‰</span>
curl -sS -X POST http://localhost:8001/services \
  -d name=mashup-svc \
  -d url=http://quarkus-authz:8080

<span class="hljs-comment"># /mashup ã® Route</span>
curl -sS -X POST http://localhost:8001/services/mashup-svc/routes \
  -d name=mashup-route \
  -d paths[]=/mashup \
  -d strip_path=<span class="hljs-literal">false</span>
</div></code></pre>
<p>Kong ã®ãƒ«ãƒ¼ãƒˆè¨­å®šã‚’ç¢ºèªï¼š</p>
<pre class="hljs"><code><div>curl -s http://localhost:8001/routes | jq <span class="hljs-string">'.data[] | {id, paths, strip_path, service_id: .service.id}'</span>
</div></code></pre>
<p>paths ã« &quot;/mashup&quot; ãŒã‚ã‚‹ãƒ«ãƒ¼ãƒˆã® id ã‚’æ§ãˆã¦ã€strip_path=false ã«æ›´æ–°ã—ã¾ã™ã€‚</p>
<pre class="hljs"><code><div>ROUTE_ID=&lt;ã•ã£ãæ§ãˆãŸID&gt;

curl -sS -X PATCH http://localhost:8001/routes/<span class="hljs-variable">$ROUTE_ID</span> \
  -d strip_path=<span class="hljs-literal">false</span>
</div></code></pre>
<blockquote>
<p>ã“ã‚Œã§ **<a href="http://localhost:8000/mashup**%EF%BC%88Kong">http://localhost:8000/mashup**ï¼ˆKong</a> çµŒç”±ï¼‰â†’ <code>quarkus-authz:8080/mashup</code> ã«åˆ°é”ã€‚</p>
</blockquote>
<h2 id="%E4%BB%A5%E4%B8%8B%E3%81%94%E5%8F%82%E8%80%83">ä»¥ä¸‹ã”å‚è€ƒ</h2>
<blockquote>
<p><code>authz-service</code> ã¯ <strong>Quarkus /hello</strong> ã‚’è£ã«å‘ã‘ã¾ã™ã€‚
<code>/secure</code> ã¸æ¥ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ Quarkus <code>/hello</code> ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€‚
Keycloak ã‹ã‚‰ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ <code>/hello</code> ã«ã‚‚å‚™ãˆã¦ <strong>/hello ãƒ«ãƒ¼ãƒˆ</strong>ã‚’è¿½åŠ ã—ã¾ã™ã€‚</p>
</blockquote>
<pre class="hljs"><code><div><span class="hljs-comment"># 1) Service ä½œæˆï¼ˆæœ€åˆã¯ãƒ™ãƒ¼ã‚¹URLï¼‰</span>
curl -i -X POST http://localhost:8001/services \
  --data name=authz-service \
  --data url=http://quarkus-authz:8080

<span class="hljs-comment"># 2) Service ã® URL ã‚’ /hello ã«å¤‰æ›´ï¼ˆ/secure â†’ /hello ã«å±Šãã‚ˆã†ã«ï¼‰</span>
curl -i -X PATCH http://localhost:8001/services/authz-service \
  --data url=http://quarkus-authz:8080/hello

<span class="hljs-comment"># 3) /secure ãƒ«ãƒ¼ãƒˆä½œæˆï¼ˆåˆå›ã‚¢ã‚¯ã‚»ã‚¹å…¥å£ï¼‰</span>
curl -i -X POST http://localhost:8001/services/authz-service/routes \
  --data paths[]=/secure

<span class="hljs-comment"># 4) /hello ãƒ«ãƒ¼ãƒˆä½œæˆï¼ˆKeycloakã®redirect_uriå…ˆã‚’å—ã‘ã‚‹ï¼‰</span>
curl -i -X POST http://localhost:8001/services/authz-service/routes \
  --data paths[]=/hello

<span class="hljs-comment"># 5) Host æƒ…å ±ã‚’ä¸Šæµã«æ¸¡ã™ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¾©å…ƒã«æœ‰åˆ©ï¼‰</span>
SECURE_ROUTE_ID=$(curl -s http://localhost:8001/routes | jq -r <span class="hljs-string">'.data[] | select(.paths|index("/secure")) | .id'</span>)
HELLO_ROUTE_ID=$(curl -s http://localhost:8001/routes | jq -r <span class="hljs-string">'.data[] | select(.paths|index("/hello")) | .id'</span>)

curl -i -X PATCH http://localhost:8001/routes/<span class="hljs-variable">$SECURE_ROUTE_ID</span> --data preserve_host=<span class="hljs-literal">true</span>
curl -i -X PATCH http://localhost:8001/routes/<span class="hljs-variable">$HELLO_ROUTE_ID</span>  --data preserve_host=<span class="hljs-literal">true</span>

<span class="hljs-comment"># ï¼ˆä»»æ„ï¼‰Kong ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ»ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ï¼ˆä¿å­˜å…ˆ=Kong DBï¼‰</span>
<span class="hljs-comment"># â€» OSS ã® session ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ storage=kong or cookie ã®ã¿ï¼ˆredisã¯ä¸å¯ï¼‰</span>
curl -i -X POST http://localhost:8001/routes/<span class="hljs-variable">$SECURE_ROUTE_ID</span>/plugins \
  --data name=session \
  --data config.storage=kong \
  --data config.secret=$(openssl rand -hex 32) \
  --data config.cookie_samesite=Lax \
  --data config.cookie_http_only=<span class="hljs-literal">true</span> \
  --data config.cookie_secure=<span class="hljs-literal">false</span>

curl -i -X POST http://localhost:8001/routes/<span class="hljs-variable">$HELLO_ROUTE_ID</span>/plugins \
  --data name=session \
  --data config.storage=kong \
  --data config.secret=$(openssl rand -hex 32) \
  --data config.cookie_samesite=Lax \
  --data config.cookie_http_only=<span class="hljs-literal">true</span> \
  --data config.cookie_secure=<span class="hljs-literal">false</span>
</div></code></pre>
<blockquote>
<p>ğŸ” è£œè¶³</p>
<ul>
<li><code>/secure</code> ã¯ã€Œå…¥å£ã€ç”¨ã®è¦‹ã›ãƒ‘ã‚¹ã€‚Kong ãŒ upstream ã® <code>/hello</code> ã«ç¹‹ãã¾ã™ã€‚</li>
<li><code>/hello</code> ãƒ«ãƒ¼ãƒˆã¯ <strong>Keycloak ã® <code>redirect_uri</code></strong> ã‚’ç›´æ¥å—ã‘ã‚‹ãŸã‚ã«å¿…è¦ã§ã™ã€‚</li>
<li><code>preserve_host=true</code> ã§ <code>Host: localhost:8000</code> ãŒ Quarkus ã¸ä¼ã‚ã‚Šã€
<code>quarkus.http.proxy.proxy-address-forwarding=true</code> ã¨ç›¸ã¾ã£ã¦ã€æ­£ã—ã„å¤–éƒ¨ URL ã«å¾©å…ƒã•ã‚Œã¾ã™ã€‚</li>
<li>å¤§ããªãƒˆãƒ¼ã‚¯ãƒ³ç­‰ã§ 502/å¤§ãã„ãƒ˜ãƒƒãƒ€ç³»ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã‚‰ <code>kong-nginx-http.conf</code> ã®å€¤ã‚’å°‘ã—å¢—ã‚„ã—ã¦ãã ã•ã„ã€‚</li>
</ul>
</blockquote>
<hr>
<h1 id="6-quarkus-%E5%81%B4%E3%81%AE%E8%A8%AD%E5%AE%9A%E6%9C%80%E7%B5%82%E7%A2%BA%E8%AA%8D">6. Quarkus å´ã®è¨­å®šï¼ˆæœ€çµ‚ç¢ºèªï¼‰</h1>
<p><code>quarkus-authz/src/main/resources/application.properties</code>ï¼ˆã‚ãªãŸã®ç¾è¡Œã§OKï¼‰</p>
<ul>
<li>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒŠãƒ³ãƒˆï¼ˆweb-appï¼‰</li>
<li><strong>Named tenant <code>&quot;service&quot;</code>ï¼ˆapplication-type=serviceï¼‰</strong></li>
<li><code>/mashup</code> ã‚’ <code>authenticated</code></li>
<li>Rest Client ã® URL ã¯ <code>http://service-a:8080</code> / <code>http://service-b:8080</code></li>
<li><code>MashupResource</code> ã« <code>@Tenant(&quot;service&quot;)</code>ï¼ˆï¼**/mashup ã¯ Bearer å°‚ç”¨**ï¼‰</li>
</ul>
<p><code>MashupResource</code>ï¼ˆã‚ãªãŸã®ç¾è¡Œã§OKï¼‰</p>
<ul>
<li>AccessToken ã‚’ <code>SecurityIdentity</code> ã‹ã‚‰å–å¾—ã—ã€ãã®ã¾ã¾ <strong>Authorization: Bearer ...</strong> ã§ä¸‹æµã¸è»¢é€</li>
</ul>
<hr>
<h1 id="7-%E4%B8%8B%E6%B5%81%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9ab%E8%A8%AD%E5%AE%9A">7. ä¸‹æµã‚µãƒ¼ãƒ“ã‚¹ï¼ˆA/Bï¼‰è¨­å®š</h1>
<p><code>service-a</code> / <code>service-b</code> ã® <code>application.properties</code>ï¼ˆç¾è¡Œã§OKï¼‰</p>
<pre class="hljs"><code><div><span class="hljs-meta">quarkus.oidc.auth-server-url</span>=<span class="hljs-string">${QUARKUS_OIDC_AUTH_SERVER_URL}</span>
<span class="hljs-meta">quarkus.oidc.client-id</span>=<span class="hljs-string">${QUARKUS_OIDC_CLIENT_ID}</span>
<span class="hljs-meta">quarkus.oidc.application-type</span>=<span class="hljs-string">service</span>
<span class="hljs-comment">
# ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å†…ãƒ­ãƒ¼ãƒ«ã‚’ä½¿ç”¨</span>
<span class="hljs-meta">quarkus.oidc.roles.source</span>=<span class="hljs-string">accesstoken</span>
<span class="hljs-meta">quarkus.oidc.roles.role-claim-path</span>=<span class="hljs-string">resource_access["service-a"].roles  # (A)</span>
<span class="hljs-comment"># B ã®ã»ã†ã¯ ["service-b"]</span>
</div></code></pre>
<blockquote>
<p><strong>ã‚¹ãƒšãƒ«ã¯ <code>accesstoken</code>ï¼ˆãƒã‚¤ãƒ•ãƒ³/ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ç„¡ã—ï¼‰</strong>
ã“ã“ãŒé–“é•ã†ã¨èµ·å‹•æ™‚ã« enum å¤‰æ›ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚</p>
</blockquote>
<blockquote>
<p>ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ <code>A: /a/data</code> / <code>B: /b/data</code>ã€‚
èªå¯ã‚’å³ã—ãã—ãŸã„å ´åˆã¯ <code>@RolesAllowed(&quot;read&quot;)</code> ã‚’å¾©æ´»ã•ã›ã‚Œã°ã€
ãƒˆãƒ¼ã‚¯ãƒ³å†…ã® <code>resource_access[&quot;service-?&quot;].roles</code> ãŒä½¿ã‚ã‚Œã¾ã™ã€‚</p>
</blockquote>
<hr>
<h1 id="8-%E5%8B%95%E4%BD%9C%E7%A2%BA%E8%AA%8D">8. å‹•ä½œç¢ºèª</h1>
<h2 id="81-%E7%9B%B4%E6%8E%A5%E9%9B%86%E7%B4%84api-8081-%E3%81%AB%E5%AF%BE%E3%81%97%E3%81%A6">8.1 ç›´æ¥ï¼ˆé›†ç´„API 8081 ã«å¯¾ã—ã¦ï¼‰</h2>
<ul>
<li>
<p>ãƒ–ãƒ©ã‚¦ã‚¶ã§ <code>http://localhost:8081/mashup</code>
â†’ <strong>åˆå›ã¯ 302 ã§ Keycloak ãƒ­ã‚°ã‚¤ãƒ³</strong> â†’ ãƒ­ã‚°ã‚¤ãƒ³å¾Œã« <code>/mashup</code> ã¸æˆ»ã‚Šã€çµæœãŒè¡¨ç¤º
ï¼ˆ<code>MashupResource</code> ã‚’ web-app ã§å—ã‘ã¦ã‹ã‚‰ <strong>å†…éƒ¨ã§ service ãƒ†ãƒŠãƒ³ãƒˆã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨</strong>ã™ã‚‹æ§‹æˆï¼‰</p>
<ul>
<li>ã‚‚ã— <strong>401</strong> ãŒæ¬²ã—ã„ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ãŸããªã„ï¼‰ãªã‚‰ã€<code>MashupResource</code> ã‚’ <code>&quot;service&quot;</code> ãƒ†ãƒŠãƒ³ãƒˆã®ã¿ã§å—ã‘ã‚‹æ§‹æˆã«å¤‰æ›´ã—ã€<code>/mashup</code> ã‚’ web-app å´ã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å¤–ã™é‹ç”¨ã«ã—ã¾ã™ã€‚ä»Šå›ã¯ãƒ­ã‚°ã‚¤ãƒ³è¦æ±‚ãŒè¦ä»¶ãªã®ã§ç¾è¡Œã®ã¾ã¾ã§OKã€‚</li>
</ul>
</li>
<li>
<p>CLIï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚°ãƒ©ãƒ³ãƒˆã§ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—â†’Bearer ã§å‘¼ã¶ï¼‰</p>
</li>
</ul>
<pre class="hljs"><code><div>TOKEN=$(curl -s -X POST \
  <span class="hljs-string">'http://localhost:8080/realms/demo-realm/protocol/openid-connect/token'</span> \
  -d <span class="hljs-string">'grant_type=password'</span> \
  -d <span class="hljs-string">'client_id=quarkus-client'</span> \
  -d <span class="hljs-string">'username=testuser'</span> \
  -d <span class="hljs-string">'password=password'</span> | jq -r .access_token)

curl -i http://localhost:8081/mashup -H <span class="hljs-string">"Authorization: Bearer <span class="hljs-variable">$TOKEN</span>"</span>
</div></code></pre>
<p>æœŸå¾…ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼š</p>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"fromServiceA"</span>: { <span class="hljs-attr">"message"</span>: <span class="hljs-string">"ok-from-A"</span>, <span class="hljs-attr">"detail"</span>: <span class="hljs-string">"helloA"</span> },
  <span class="hljs-attr">"fromServiceB"</span>: { <span class="hljs-attr">"message"</span>: <span class="hljs-string">"ok-from-b"</span>, <span class="hljs-attr">"detail"</span>: <span class="hljs-string">"helloB"</span> }
}
</div></code></pre>
<h2 id="82-kong-%E7%B5%8C%E7%94%B1%E3%83%97%E3%83%AD%E3%82%AD%E3%82%B7-8000">8.2 Kong çµŒç”±ï¼ˆãƒ—ãƒ­ã‚­ã‚· 8000ï¼‰</h2>
<pre class="hljs"><code><div><span class="hljs-comment"># ãƒ–ãƒ©ã‚¦ã‚¶ or curl</span>
curl -i http://localhost:8000/mashup
<span class="hljs-comment"># ãƒ–ãƒ©ã‚¦ã‚¶ãªã‚‰ Quarkusâ†’Keycloak ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ â†’ /mashup è¡¨ç¤º</span>
</div></code></pre>
<blockquote>
<p>Kong ã¯<strong>ç´ é€šã—</strong>ãªã®ã§ã€èªè¨¼ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã¯ Quarkus ãŒæ‹…å½“ã€‚
å°†æ¥ã€Kong å´ã§ WAF/RateLimit ã‚„ API ã‚­ãƒ¼ãªã©ã®â€œå…¥å£åˆ¶å¾¡â€ã‚‚è¶³ã›ã¾ã™ã€‚</p>
</blockquote>
<hr>
<h1 id="9-%E3%82%88%E3%81%8F%E3%81%82%E3%82%8B%E3%83%8F%E3%83%9E%E3%82%8A--tips">9. ã‚ˆãã‚ã‚‹ãƒãƒã‚Š &amp; TIPS</h1>
<ul>
<li>
<p><strong>roles.source ã®å€¤</strong>
<code>accesstoken</code> ä»¥å¤–ï¼ˆ<code>access_token</code>/<code>access-token</code>ï¼‰ã¯<strong>èµ·å‹•ã‚¨ãƒ©ãƒ¼</strong>ã«ãªã‚Šã¾ã™ã€‚</p>
</li>
<li>
<p><strong>ãƒ­ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„</strong>
<code>role-claim-path</code> ã®ã‚­ãƒ¼ï¼ˆ<code>&quot;service-a&quot;</code> / <code>&quot;service-b&quot;</code>ï¼‰ãŒæ­£ã—ã„ã‹å†ç¢ºèªã€‚</p>
</li>
<li>
<p><strong>aud ãŒè¶³ã‚Šãªã„</strong>
Audience ãƒãƒƒãƒ‘ãƒ¼ã§ <code>service-a</code> / <code>service-b</code> ã‚’è¿½åŠ ã—ãŸã‹ç¢ºèªã€‚
<code>echo $TOKEN | cut -d . -f2 | tr '_-' '/+' | base64 -d | jq .aud</code></p>
</li>
<li>
<p><strong>ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™</strong>
403/401 ã‚„ãƒ­ã‚°ã« â€œThe JWT is no longer validâ€ ãŒå‡ºãŸã‚‰å†å–å¾—ã€‚</p>
</li>
<li>
<p><strong>var ãŒã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ä¸èƒ½</strong>
JDK 17 ã‚’ä½¿ã†ï¼ˆpom.xml ã§ <code>&lt;maven.compiler.release&gt;17&lt;/maven.compiler.release&gt;</code>ï¼‰ã€‚
ãã‚Œã§ã‚‚ãƒ€ãƒ¡ãªã‚‰ <code>var</code> ã‚’æ˜ç¤ºå‹ã«ç½®ãæ›ãˆã€‚</p>
</li>
<li>
<p><strong>ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒƒã‚­ãƒ¼ãŒå¤§ãã„è­¦å‘Š</strong>ï¼ˆé›†ç´„å´ï¼‰
é–‹ç™ºä¸­ã¯ç„¡è¦–ã§ã‚‚OKã€‚æ°—ã«ãªã‚‹å ´åˆã¯ï¼š</p>
<pre class="hljs"><code><div>quarkus.oidc.token-state-manager.split-tokens=true
</div></code></pre>
<p>ï¼ˆã‚ã‚‹ã„ã¯ <code>strategy=id-refresh-tokens</code> ã§ Access Token ã‚’ã‚¯ãƒƒã‚­ãƒ¼ã«å«ã‚ãªã„é‹ç”¨ã«å¤‰æ›´ï¼‰</p>
</li>
</ul>
<hr>
<p>ä»¥ä¸‹ã§ã€æ¥ç¶šãŒæˆåŠŸã™ã‚‹å ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚</p>
<pre class="hljs"><code><div>docker compose down
docker compose up -d
</div></code></pre>
<hr>
<h1 id="10-%E6%9C%9F%E5%BE%85%E3%81%99%E3%82%8B%E5%A4%9A%E6%AE%B5%E8%AA%8D%E5%8F%AF%E3%81%AE%E6%B5%81%E3%82%8C%E5%86%8D%E6%8E%B2">10. æœŸå¾…ã™ã‚‹â€œå¤šæ®µèªå¯â€ã®æµã‚Œï¼ˆå†æ²ï¼‰</h1>
<ol>
<li><strong>é›†ç´„API</strong>ï¼šKeycloak ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ï¼ˆOIDCï¼‰</li>
<li><strong>é›†ç´„APIå†…èªå¯</strong>ï¼šãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ A/B ã‚’å‘¼ã¶è¦ä»¶ã‚’æº€ãŸã™ã‹ï¼ˆå¿…è¦ãªã‚‰ <code>@RolesAllowed</code> ç­‰ã§ï¼‰</li>
<li><strong>ãƒˆãƒ¼ã‚¯ãƒ³ä¼æ¬</strong>ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã® Access Token ã‚’ <code>Authorization: Bearer</code> ã§ A/B ã«è»¢é€</li>
<li><strong>ä¸‹æµ A/B èªå¯</strong>ï¼šãã‚Œãã‚Œ <code>roles.source=accesstoken</code> + <code>role-claim-path</code> ã§<strong>è‡ªå‰ã®ãƒãƒªã‚·ãƒ¼</strong></li>
<li><strong>çµæœãƒãƒ¼ã‚¸</strong>ï¼š<code>{ fromServiceA, fromServiceB }</code> ã‚’çµ±åˆã—ã¦è¿”å´</li>
</ol>
<hr>
<p>ä»¥ä¸Šã§ã™ã€‚</p>

</body>
</html>
