ä»¥ä¸‹ã«ã€**Kong ã¨ Quarkus (èªå¯ API) ã‚’é€£æºã•ã›ã‚‹ãŸã‚ã®æ‰‹é †**ã‚’ã¾ã¨ã‚ã¾ã™ã€‚
ã“ã®æ‰‹é †ã§ã¯ã€Quarkus REST API (`/authz/check`) ã‚’ Kong çµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«æ§‹æˆã—ã¾ã™ã€‚

---

## âœ… ç›®çš„

Kong Gateway ã‚’é€šã˜ã¦ã€Quarkus ã‚¢ãƒ—ãƒªï¼ˆèªå¯ãƒã‚§ãƒƒã‚¯ APIï¼‰ã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹ã€‚

---

## ğŸ”§ å‰æ

* Docker & Docker Compose ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿
* `docker-compose.yaml` ã« Kong, Quarkus, Redis ç­‰ã®ã‚µãƒ¼ãƒ“ã‚¹å®šç¾©ãŒã‚ã‚‹ï¼ˆæ—¢ã«ç¢ºèªæ¸ˆï¼‰
* Quarkus ã‚¢ãƒ—ãƒªï¼ˆ`/authz/check`ï¼‰ãŒ `http://quarkus-authz:8080` ã§å¿œç­”ã™ã‚‹

---

## ğŸªœ æ‰‹é †ä¸€è¦§

### â‘  Quarkus ã‚¢ãƒ—ãƒªã®ãƒ“ãƒ«ãƒ‰

```bash
cd quarkus-authz/
mvn clean package -DskipTests
```

### â‘¡ Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰

```bash
docker build -t quarkus-authz .
```

### â‘¢ docker-compose ã§å…¨ä½“ã‚’èµ·å‹•

```bash
cd ..
docker compose up -d
```

â€» åˆå›ã®ã¿ Kong DB ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œï¼š

```bash
docker compose run --rm kong kong migrations bootstrap
```

---

## ğŸ”„ Kong ã« Quarkus ã®ãƒ«ãƒ¼ãƒˆã‚’è¿½åŠ 

### â‘  Service ç™»éŒ²ï¼ˆKong â†’ Quarkusï¼‰

```bash
curl -i -X POST http://localhost:8001/services \
  --data name=authz-service \
  --data url=http://quarkus-authz:8080
```

### â‘¡ Route ç™»éŒ²ï¼ˆKong ã§ `/authz` ã‚’ `/authz` ã«è»¢é€ï¼‰

```bash
curl -i -X POST http://localhost:8001/services/authz-service/routes \
  --data paths[]=/authz \
  --data strip_path=false
```

> âœ… `strip_path=false` ã«ã‚ˆã‚Šã€Kong ã¯ `/authz/check` ã‚’ãã®ã¾ã¾è»¢é€ã—ã¾ã™ã€‚

---

## âœ… å‹•ä½œç¢ºèª

ä»¥ä¸‹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼š

```bash
curl -X POST http://localhost:8000/authz/check \
  -H "Content-Type: application/json" \
  -d '{"user": "allowed"}'
```

### ğŸ¯ ãƒ¬ã‚¹ãƒãƒ³ã‚¹æœŸå¾…å€¤ï¼š

```json
{"authorized":true}
```

---

## ğŸ§¹ è£œè¶³ï¼ˆä¸è¦ãª Route ã®å‰Šé™¤ï¼‰

é‡è¤‡ã—ã¦ç™»éŒ²ã•ã‚ŒãŸå¤ã„ãƒ«ãƒ¼ãƒˆã¯ä»¥ä¸‹ã§å‰Šé™¤ã§ãã¾ã™ï¼š

```bash
curl -X DELETE http://localhost:8001/routes/<route-id>
```

ä¸€è¦§å–å¾—ï¼š

```bash
curl http://localhost:8001/routes
```

---

## ğŸ“ ãƒ¡ãƒ¢

| é …ç›®             | å€¤                                              |
| -------------- | ---------------------------------------------- |
| Kong Admin API | [http://localhost:8001](http://localhost:8001) |
| Kong Proxy     | [http://localhost:8000](http://localhost:8000) |
| Quarkus App    | [http://localhost:8081](http://localhost:8081) |
| Quarkus å†…éƒ¨å    | `quarkus-authz`ï¼ˆcompose ä¸Šï¼‰                     |

---

## æ¬¡ã«ãŠã™ã™ã‚

* ğŸ” Kong ã« JWT / OAuth2 ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’è¿½åŠ 
* ğŸ“¦ Quarkus å´ã§ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ or å±æ€§ãƒ™ãƒ¼ã‚¹èªå¯
* ğŸ“Š Kong ã« Prometheus / Grafana é€£æº

---

