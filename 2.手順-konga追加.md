補足：
（※主な修正：KeycloakのRedirect URIを`http://localhost:8000/hello`に統一／Quarkus設定は`application.properties`に一元化／KongのNginx拡張を`KONG_NGINX_HTTP_INCLUDE`で読み込む／`/hello`ルートも作成 など）

---

# ✅ 多段認証構成：統合セットアップ手順（最新版）

構成：

* **Kong Gateway**：API ゲートウェイ
* **PostgreSQL**：Kong/Konga 用 DB
* **Konga**：Kong 管理 GUI
* **Redis**：任意（Quarkus 側で使う場合）
* **Keycloak**：OIDC 認証プロバイダー
* **Quarkus**：OIDC処理を実施するアプリ（/hello を保護）

---

## 🧱 1. ファイル準備

### (1) `docker-compose.yaml`

> `version:` 行は不要（Dockerが警告するため）。
> Kong に Nginx の `http{}` 用設定を**インクルード**します（巨大ヘッダ対策）。

```yaml
services:
  kong-database:
    image: postgres:10
    environment:
      POSTGRES_USER: kong
      POSTGRES_DB: kong
      POSTGRES_PASSWORD: kong
    volumes:
      - kong_data:/var/lib/postgresql/data
      - ./init-konga-db.sql:/docker-entrypoint-initdb.d/init-konga-db.sql

  redis:
    image: redis:7
    ports:
      - "6379:6379"

  kong:
    image: kong:3.6.0
    depends_on:
      - kong-database
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: kong
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_PLUGINS: bundled
      # ← 重要: Keycloak トークン等でヘッダが大きくなる対策
      KONG_NGINX_HTTP_INCLUDE: /usr/local/kong/nginx-http.conf
    ports:
      - "8000:8000"  # Proxy
      - "8001:8001"  # Admin API
    command: ["kong", "docker-start"]
    volumes:
      - ./kong-nginx-http.conf:/usr/local/kong/nginx-http.conf:ro

  konga:
    image: pantsel/konga:latest
    container_name: konga
    restart: always
    environment:
      - NODE_ENV=development
      - DB_ADAPTER=postgres
      - DB_HOST=kong-database
      - DB_USER=kong
      - DB_PASSWORD=kong
      - DB_DATABASE=konga
    ports:
      - "1337:1337"
    depends_on:
      - kong-database

  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    command: start-dev
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    ports:
      - "8080:8080"

  quarkus-authz:
    build:
      context: ./quarkus-authz
      dockerfile: Dockerfile
    depends_on:
      - redis
    environment:
      # QUARKUS_* は application.properties に寄せるため不要
      REDIS_HOST: redis
    ports:
      - "8081:8080"

volumes:
  kong_data:
```

### (2) `kong-nginx-http.conf`（新規）

> `KONG_NGINX_HTTP_INCLUDE` で読み込まれ、`http{}` コンテキストに挿入されます。
> これで「upstream sent too big header」などを回避できます。

```nginx
# サイズ系は必要に応じて増減
proxy_buffer_size        256k;
proxy_buffers            8 256k;
proxy_busy_buffers_size  256k;

# 大きめのクッキー/ヘッダを受ける
large_client_header_buffers 4 16k;
```

### (3) `init-konga-db.sql`（新規）

> Konga 用 DB を自動作成（オーナーは `kong` ユーザーに）。

```sql
CREATE DATABASE konga OWNER kong;
```

---

## ⚙️ 2. Quarkus 設定（`quarkus-authz/src/main/resources/application.properties`）

> **設定はここに一元化**（`docker-compose.yaml` の `QUARKUS_*` は削除済み）。

```properties
# Keycloak（Docker ネットワーク名で到達）
quarkus.oidc.auth-server-url=http://keycloak:8080/realms/demo-realm
quarkus.oidc.client-id=quarkus-client
quarkus.oidc.application-type=web-app

# /hello を保護（未ログインなら Keycloak へ）
quarkus.http.auth.permission.protected.paths=/hello
quarkus.http.auth.permission.protected.policy=authenticated

# 逆プロキシ(Kong)越しの URL/Host 復元
quarkus.http.proxy.proxy-address-forwarding=true

# リダイレクト先のアプリ側ハンドラ
quarkus.oidc.authentication.redirect-path=/hello

# OIDC state の暗号鍵（32文字以上）
quarkus.oidc.token-state-manager.encryption-secret=change_me_32_chars_min
# クッキーを軽量化
quarkus.oidc.token-state-manager.strategy=id-token
quarkus.oidc.token-state-manager.split-tokens=true
```

---

## 🔐 3. Keycloak 設定（OIDC）

1. `http://localhost:8080` で `admin/admin` でログイン
2. **Realm** 作成：`demo-realm`
3. **Client** 追加：

   * Client ID: `quarkus-client`
   * Client authentication: **OFF**（Public）
   * Access Type: **public**
   * **Valid Redirect URIs**: `http://localhost:8000/hello` ← 重要（Kong 経由）
   * （必要なら）Web Origins: `http://localhost:8000` も追加
4. ユーザー作成：`testuser / password`（有効化）

---

## 🚀 4. 起動

```bash
docker compose up -d --build
docker ps
```

---

## 🔗 5. Kong で Service/Route を作成

> `authz-service` は **Quarkus /hello** を裏に向けます。
> `/secure` へ来たリクエストを Quarkus `/hello` にルーティング。
> Keycloak からのリダイレクト `/hello` にも備えて **/hello ルート**を追加します。

```bash
# 1) Service 作成（最初はベースURL）
curl -i -X POST http://localhost:8001/services \
  --data name=authz-service \
  --data url=http://quarkus-authz:8080

# 2) Service の URL を /hello に変更（/secure → /hello に届くように）
curl -i -X PATCH http://localhost:8001/services/authz-service \
  --data url=http://quarkus-authz:8080/hello

# 3) /secure ルート作成（初回アクセス入口）
curl -i -X POST http://localhost:8001/services/authz-service/routes \
  --data paths[]=/secure

# 4) /hello ルート作成（Keycloakのredirect_uri先を受ける）
curl -i -X POST http://localhost:8001/services/authz-service/routes \
  --data paths[]=/hello

# 5) Host 情報を上流に渡す（リダイレクト復元に有利）
SECURE_ROUTE_ID=$(curl -s http://localhost:8001/routes | jq -r '.data[] | select(.paths|index("/secure")) | .id')
HELLO_ROUTE_ID=$(curl -s http://localhost:8001/routes | jq -r '.data[] | select(.paths|index("/hello")) | .id')

curl -i -X PATCH http://localhost:8001/routes/$SECURE_ROUTE_ID --data preserve_host=true
curl -i -X PATCH http://localhost:8001/routes/$HELLO_ROUTE_ID  --data preserve_host=true

# （任意）Kong セッション・プラグイン（保存先=Kong DB）
# ※ OSS の session プラグインは storage=kong or cookie のみ（redisは不可）
curl -i -X POST http://localhost:8001/routes/$SECURE_ROUTE_ID/plugins \
  --data name=session \
  --data config.storage=kong \
  --data config.secret=$(openssl rand -hex 32) \
  --data config.cookie_samesite=Lax \
  --data config.cookie_http_only=true \
  --data config.cookie_secure=false

curl -i -X POST http://localhost:8001/routes/$HELLO_ROUTE_ID/plugins \
  --data name=session \
  --data config.storage=kong \
  --data config.secret=$(openssl rand -hex 32) \
  --data config.cookie_samesite=Lax \
  --data config.cookie_http_only=true \
  --data config.cookie_secure=false
```

> 🔎 補足
>
> * `/secure` は「入口」用の見せパス。Kong が upstream の `/hello` に繋ぎます。
> * `/hello` ルートは **Keycloak の `redirect_uri`** を直接受けるために必要です。
> * `preserve_host=true` で `Host: localhost:8000` が Quarkus へ伝わり、
>   `quarkus.http.proxy.proxy-address-forwarding=true` と相まって、正しい外部 URL に復元されます。
> * 大きなトークン等で 502/大きいヘッダ系のエラーが出たら `kong-nginx-http.conf` の値を少し増やしてください。

---

## 🖥️ 6. Konga 初期セットアップ

1. `http://localhost:1337` にアクセス、管理者ユーザーを作成
2. 「**+ Add Connection**」→

   * **Name**: kong-local
   * **Kong Admin URL**: `http://kong:8001`
   * Health Check: ON → Create

---

## ✅ 7. 動作確認

1. ブラウザで `http://localhost:8000/secure`
2. Keycloak のログイン画面にリダイレクト
3. `testuser/password` でログイン
4. Quarkus の `/hello` が 200 を返す（例: `Hello from Quarkus Authz!`）
5. エラーが出たら `docker logs` で `3-quarkus-authz-1` / `3-kong-1` / `3-keycloak-1` を確認

---

## 📦 データ初期化

```bash
docker compose down -v
```

---

## 🎯 ポート一覧

| コンポーネント    | ポート       | 用途                |
| ---------- | --------- | ----------------- |
| Kong       | 8000/8001 | Proxy / Admin API |
| Konga      | 1337      | Kong GUI          |
| Keycloak   | 8080      | OIDC IdP          |
| Quarkus    | 8081      | アプリ（内部は 8080）     |
| Redis      | 6379      | 任意（アプリで利用する場合）    |
| PostgreSQL | 内部        | Kong/Konga データストア |

---

### 変更点サマリ（今回の修正）

* `QUARKUS_*` の環境変数は**削除**（properties に一元化）
* Keycloak の **Valid Redirect URIs** を `http://localhost:8000/hello` に変更
* Kong の Nginx 拡張は **`KONG_NGINX_HTTP_INCLUDE`** で http コンテキストにインクルード
* **/hello ルートを追加**（Keycloak の `redirect_uri` を受けるため）
* `preserve_host=true` を `/secure` と `/hello` に設定
* Konga 用 DB を `init-konga-db.sql` で自動作成

---
以下未実装。
Redis にセッション情報を保存するサンプル実装（クッキーの state とは別管理）