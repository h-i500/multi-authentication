以下に、**Kong と Quarkus (認可 API) を連携させるための手順**をまとめます。
この手順では、Quarkus REST API (`/authz/check`) を Kong 経由でアクセスできるように構成します。

---

## ✅ 目的

Kong Gateway を通じて、Quarkus アプリ（認可チェック API）へリクエストをルーティングする。

---

## 🔧 前提

* Docker & Docker Compose がインストール済み
* `docker-compose.yaml` に Kong, Quarkus, Redis 等のサービス定義がある（既に確認済）
* Quarkus アプリ（`/authz/check`）が `http://quarkus-authz:8080` で応答する

---

## 🪜 手順一覧

### ① Quarkus アプリのビルド

```bash
cd quarkus-authz/
mvn clean package -DskipTests
```

### ② Docker イメージのビルド

```bash
docker build -t quarkus-authz .
```

### ③ docker-compose で全体を起動

```bash
cd ..
docker compose up -d
```

※ 初回のみ Kong DB のマイグレーションを実行：

```bash
docker compose run --rm kong kong migrations bootstrap
```

---

## 🔄 Kong に Quarkus のルートを追加

### ① Service 登録（Kong → Quarkus）

```bash
curl -i -X POST http://localhost:8001/services \
  --data name=authz-service \
  --data url=http://quarkus-authz:8080
```

### ② Route 登録（Kong で `/authz` を `/authz` に転送）

```bash
curl -i -X POST http://localhost:8001/services/authz-service/routes \
  --data paths[]=/authz \
  --data strip_path=false
```

> ✅ `strip_path=false` により、Kong は `/authz/check` をそのまま転送します。

---

## ✅ 動作確認

以下のリクエストを実行：

```bash
curl -X POST http://localhost:8000/authz/check \
  -H "Content-Type: application/json" \
  -d '{"user": "allowed"}'
```

### 🎯 レスポンス期待値：

```json
{"authorized":true}
```

---

## 🧹 補足（不要な Route の削除）

重複して登録された古いルートは以下で削除できます：

```bash
curl -X DELETE http://localhost:8001/routes/<route-id>
```

一覧取得：

```bash
curl http://localhost:8001/routes
```

---

## 📝 メモ

| 項目             | 値                                              |
| -------------- | ---------------------------------------------- |
| Kong Admin API | [http://localhost:8001](http://localhost:8001) |
| Kong Proxy     | [http://localhost:8000](http://localhost:8000) |
| Quarkus App    | [http://localhost:8081](http://localhost:8081) |
| Quarkus 内部名    | `quarkus-authz`（compose 上）                     |

---

## 次におすすめ

* 🔐 Kong に JWT / OAuth2 プラグインを追加
* 📦 Quarkus 側でトークン検証 or 属性ベース認可
* 📊 Kong に Prometheus / Grafana 連携

---

